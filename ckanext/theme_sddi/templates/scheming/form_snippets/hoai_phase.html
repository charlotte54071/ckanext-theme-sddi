<div class="form-group">
  <label for="field-hoai_phase">HOAI Service Phase</label>
  <select id="field-hoai_phase" name="hoai_phase" class="form-control">
    <option value="">-- Select HOAI Phase --</option>
    <option value="LPH 1">LPH 1 – Basic Evaluation</option>
    <option value="LPH 2">LPH 2 – Preliminary Design</option>
    <option value="LPH 3">LPH 3 – Design Planning</option>
    <option value="LPH 4">LPH 4 – Approval Planning</option>
    <option value="LPH 5">LPH 5 – Construction Drawings</option>
    <option value="LPH 6">LPH 6 – Tender Preparation</option>
    <option value="LPH 7">LPH 7 – Tender Support</option>
    <option value="LPH 8">LPH 8 – Site Supervision</option>
    <option value="LPH 9">LPH 9 – Operation Support</option>
  </select>
</div>

<script type="text/javascript">
  // 用 CKAN 的 RequireJS 加载 jQuery 确保时机正确
  require(['jquery'], function($) {
    // 当 DOM 完全就绪后
    $(function() {
      // HOAI 映射表
      var hoaiPhaseMap = {
        'pre-construction': ['LPH 1','LPH 2','LPH 6','LPH 7'],
        'survey':           ['LPH 1'],
        'design':           ['LPH 3','LPH 4','LPH 5'],
        'construction':     ['LPH 8'],
        'operation':        ['LPH 9'],
        'retirement':       []
      };

      // 过滤函数
      function updateHoai() {
        var sel = $('#field-lifecycle_phase').val() || '';
        var allow = hoaiPhaseMap[sel] || [];
        // 调试日志
        console.log('[HOAI] lifecycle_phase=', sel, '→ allowed=', allow);

        $('#field-hoai_phase option').each(function() {
          if (!this.value) return;
          $(this).toggle(allow.includes(this.value));
        });
        // 如果当前值不合法则清空
        var cur = $('#field-hoai_phase').val();
        if (cur && !allow.includes(cur)) {
          $('#field-hoai_phase').val('');
        }
      }

      // 仅当两个字段都存在时绑定
      var $lc = $('#field-lifecycle_phase');
      var $hp = $('#field-hoai_phase');
      if ($lc.length && $hp.length) {
        updateHoai();
        $lc.on('change', updateHoai);
      } else {
        console.warn('[HOAI] 找不到 lifecycle_phase 或 hoai_phase 字段');
      }
    });
  });
</script>
